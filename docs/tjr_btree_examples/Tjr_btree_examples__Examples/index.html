<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tjr_btree_examples__Examples (tjr_btree_examples.Tjr_btree_examples__Examples)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">tjr_btree_examples</a> &#x00BB; Tjr_btree_examples__Examples</nav><h1>Module <code>Tjr_btree_examples__Examples</code></h1><p>Various examples</p><nav class="toc"><ul><li><a href="#abstract-version...">Abstract version...</a></li><li><a href="#misc-prelude">Misc prelude</a></li><li><a href="#abstract-version">Abstract version</a></li><li><a href="#parameterize-over-blk_dev">Parameterize over blk_dev</a></li><li><a href="#in-memory-block-dev">In-memory block dev</a></li><li><a href="#on-disk-block-dev">On-disk block dev</a></li></ul></nav></header><aside><p>The steps to construct an example are:</p><ul><li>fix the monad type (eg store passing)</li><li>construct block ops <span class="xref-unresolved" title="unresolved reference to &quot;Tjr_fs_shared.Block_ops&quot;"><code>Tjr_fs_shared</code>.Block_ops</span>, which converts strings/bytes to/from blks</li><li>construct block device ops <span class="xref-unresolved" title="unresolved reference to &quot;Tjr_fs_shared.Blk_dev_ops_type&quot;"><code>Tjr_fs_shared</code>.Blk_dev_ops_type</span>, which reads and writes to blks</li><li>implement <span class="xref-unresolved" title="unresolved reference to &quot;Bin_prot_marshalling.node_leaf_conversions&quot;"><code>Bin_prot_marshalling</code>.node_leaf_conversions</span> to convert from list-based leaf/node impls to the efficient leaf/node impls</li><li>implement marshalling procedures via <code>Bin_prot_marshalling</code></li><li>calculate constants based on blk_sz and key and value types, and marshalling strategy</li><li>implement blk_allocator_ops, to allow allocation of blks via id</li><li>for every desired combination of (key/value types, marshalling, blk_dev, blk_allocator), use <a href="../../tjr_btree/Tjr_btree/index.html#val-uncached_disk_to_store"><code>Tjr_btree.uncached_disk_to_store</code></a> to construct a corresponding store</li><li>then use <a href="../../tjr_btree/Tjr_btree/index.html#val-store_ops_to_map_ops"><code>Tjr_btree.store_ops_to_map_ops</code></a> to convert store to a map (using a root pointer to convert the pre_map_ops to a map_ops)</li></ul><p>FIXME include this documentation in main tjr_btree lib, perhaps as a simple int-&gt;int example</p> 
<img src="https://docs.google.com/drawings/d/e/2PACX-1vSbPmP9hfqwpYdJefrAYVY_7nSf6Mf5kzAXHYEaaAbw6cLwkWJH9GImYG_4KwKRDLOOjDGMvePbodwt/pub?w=1137&amp;h=766"> 

<img src="https://docs.google.com/drawings/d/e/2PACX-1vQXKtsYnp_Z4gUHTpYZOeLrGGIIQxPQrSSgdnoUylAW269ckYBMaUXz9MlDk8aHd1evYCSJNFGpqRFb/pub?w=960&amp;h=720">
</aside><section><header><h3 id="abstract-version..."><a href="#abstract-version..." class="anchor"></a>Abstract version...</h3><p>We start with a version that abstracts over k,v, marshalling and blk_dev</p></header></section><section><header><h3 id="misc-prelude"><a href="#misc-prelude" class="anchor"></a>Misc prelude</h3></header><dl><dt class="spec type" id="type-blk_allocator_state"><a href="#type-blk_allocator_state" class="anchor"></a><code><span class="keyword">type</span> blk_allocator_state</code><code> = </code><code>{</code><table class="record"><tr id="type-blk_allocator_state.min_free_blk_id" class="anchored"><td class="def field"><a href="#type-blk_allocator_state.min_free_blk_id" class="anchor"></a><code>min_free_blk_id : int;</code></td></tr></table><code>}</code></dt></dl><aside><p>The global state is represented by a store; within the store there are refs to the block device, the block allocator state, ...</p><ul><li>blk_dev state</li><li>blk_allocator state</li></ul></aside><div class="spec module" id="module-Misc"><a href="#module-Misc" class="anchor"></a><code><span class="keyword">module</span> <a href="Misc/index.html">Misc</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Blk_ops"><a href="#module-Blk_ops" class="anchor"></a><code><span class="keyword">module</span> <a href="Blk_ops/index.html">Blk_ops</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Blk_allocator"><a href="#module-Blk_allocator" class="anchor"></a><code><span class="keyword">module</span> <a href="Blk_allocator/index.html">Blk_allocator</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Btree_root_block"><a href="#module-Btree_root_block" class="anchor"></a><code><span class="keyword">module</span> <a href="Btree_root_block/index.html">Btree_root_block</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module-type" id="module-type-BLK_DEV_OPS"><a href="#module-type-BLK_DEV_OPS" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-BLK_DEV_OPS/index.html">BLK_DEV_OPS</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section><section><header><h3 id="abstract-version"><a href="#abstract-version" class="anchor"></a>Abstract version</h3></header><div class="spec module-type" id="module-type-S"><a href="#module-type-S" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-S/index.html">S</a> = <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Internal_abstract"><a href="#module-Internal_abstract" class="anchor"></a><code><span class="keyword">module</span> <a href="Internal_abstract/index.html">Internal_abstract</a> : <span class="keyword">functor</span> (<a href="Internal_abstract/argument-1-S/index.html">S</a> : <a href="index.html#module-type-S">S</a>) <span>&#45;&gt;</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section><section><header><h3 id="parameterize-over-blk_dev"><a href="#parameterize-over-blk_dev" class="anchor"></a>Parameterize over blk_dev</h3><p>Now we parameterize only over the blk dev</p></header><div class="spec module" id="module-Internal_over_blk_dev"><a href="#module-Internal_over_blk_dev" class="anchor"></a><code><span class="keyword">module</span> <a href="Internal_over_blk_dev/index.html">Internal_over_blk_dev</a> : <span class="keyword">functor</span> (<a href="Internal_over_blk_dev/argument-1-Blk_dev_ops/index.html">Blk_dev_ops</a> : <a href="index.html#module-type-BLK_DEV_OPS">BLK_DEV_OPS</a>) <span>&#45;&gt;</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section><section><header><h3 id="in-memory-block-dev"><a href="#in-memory-block-dev" class="anchor"></a>In-memory block dev</h3><p>Finally, we can start instantiating.</p></header><div class="spec module" id="module-In_mem_blk_dev"><a href="#module-In_mem_blk_dev" class="anchor"></a><code><span class="keyword">module</span> <a href="In_mem_blk_dev/index.html">In_mem_blk_dev</a> : <a href="index.html#module-type-BLK_DEV_OPS">BLK_DEV_OPS</a></code></div><div class="spec module" id="module-In_mem"><a href="#module-In_mem" class="anchor"></a><code><span class="keyword">module</span> <a href="In_mem/index.html">In_mem</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section><section><header><h3 id="on-disk-block-dev"><a href="#on-disk-block-dev" class="anchor"></a>On-disk block dev</h3></header><div class="spec module" id="module-On_disk_blk_dev"><a href="#module-On_disk_blk_dev" class="anchor"></a><code><span class="keyword">module</span> <a href="On_disk_blk_dev/index.html">On_disk_blk_dev</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec module" id="module-On_disk"><a href="#module-On_disk" class="anchor"></a><code><span class="keyword">module</span> <a href="On_disk/index.html">On_disk</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>NOTE this requires that the fd is set in the initial fstore</p></dd></dl><aside><p>NOTE disk utils can be accessed eg via <a href="On_disk/Int_int/index.html"><code>On_disk.Int_int</code></a> (ignore the on_disk_util for in-mem versions)</p></aside></section></div></body></html>